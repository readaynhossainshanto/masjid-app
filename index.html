<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶π‡¶æ‡¶¨‡¶ø‡¶¨ ‡¶â‡¶≤‡ßç‡¶Ø‡¶æ ‡¶≠‡ßÇ‡¶Å‡¶á‡ßü‡¶æ ‡¶ú‡¶æ‡¶Æ‡ßá ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
    
    <meta name="theme-color" content="#27ae60">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json;base64,ewogICJkZWZhdWx0X2xvY2FsZSI6ICJlbiIsCiAgIm5hbWUiOiAiSGFiaWIgVWxsYWggQmh1aXlhbiBNYXNqaWQiLAogICJzaG9ydF9uYW1lIjogIkhVQiBNYXNqaWQiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YwZjJmNSIsCiAgInRoZW1lX2NvbG9yIjogIiMyN2FlNjAiLAogICJpY29ucyI6IFs7InNyYyI6ICJodHRwczovL2Nkbi1pY29ucy1wbmcuZmx0aWNvbi5jb20vNTEyLzI4NC8yODQ2MTcucG5nIiwic2l6ZXMiOiAiNTEyeDUxMiIsInR5cGUiOiAiaW1hZ2UvcG5nIn1dCn0=">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 15px; font-size: 13px; margin: 0; }
        h2 { text-align: center; color: #1a5276; margin-bottom: 5px; }
        .current-year-display { text-align: center; font-size: 20px; font-weight: bold; color: #27ae60; margin-bottom: 10px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .nav-actions { display: flex; align-items: center; gap: 8px; }
        .search-box { padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 180px; }
        .arrow-btn { cursor: pointer; font-size: 20px; color: #3498db; user-select: none; }
        .dropbtn { background-color: #3498db; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 100; border-radius: 8px; overflow: hidden; }
        .dropdown-content a, .dropdown-content label { color: #333; padding: 10px 15px; text-decoration: none; display: block; border-bottom: 1px solid #eee; cursor: pointer; }
        .show { display: block; }
        
        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 10px; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #e0e0e0; padding: 6px; text-align: center; }
        th { background-color: #27ae60; color: white; font-size: 11px; white-space: nowrap; }
        .house-group-header { background-color: #ecf0f1; text-align: left; padding: 10px; font-size: 15px; font-weight: bold; color: #2c3e50; border: 1px solid #e0e0e0; }
        
        .tk-input { width: 42px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; }
        .beton-input { width: 55px; padding: 4px; border: 1px solid #3498db; border-radius: 4px; text-align: center; font-weight: bold; background: #f7fbff; }
        .paid { background-color: #d4edda !important; color: #155724 !important; }
        .unpaid-red { background-color: #f8d7da !important; }
        .advance { background-color: #FFD700 !important; color: #000 !important; font-weight: bold; }
        .total-row { background-color: #f9f9f9; font-weight: bold; cursor: pointer; color: #1a5276; }
        
        .clickable-name { cursor: pointer; color: #1a5276; text-decoration: underline; font-weight: bold; }
        .expatriate-tag { background: #e67e22; color: white; font-size: 9px; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; display: inline-block; }
        .btn-add { background: #27ae60; color: white; padding: 9px 15px; border: none; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 12px; }

        @media print {
            .header-bar, .tk-input, .beton-input, .btn-add, .arrow-btn, .no-print { display: none !important; }
            .house-section { page-break-before: always; }
            @page { size: A4 landscape; margin: 5mm; }
        }
    </style>
</head>
<body>

<div class="no-print" style="text-align: right; padding: 5px;">
    <button id="installApp" style="display:none; background:#1a5276; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size: 11px;">üì≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<h2>üïå ‡¶π‡¶æ‡¶¨‡¶ø‡¶¨ ‡¶â‡¶≤‡ßç‡¶Ø‡¶æ ‡¶≠‡ßÇ‡¶Å‡¶á‡ßü‡¶æ ‡¶ú‡¶æ‡¶Æ‡ßá ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶</h2>
<div class="current-year-display">
    <span class="arrow-btn" onclick="changeYear(-1)">‚óÄ</span>
    ‡¶¨‡¶õ‡¶∞: <span id="yearLabel">‡ß®‡ß¶‡ß®‡ß´</span>
    <span class="arrow-btn" onclick="changeYear(1)">‚ñ∂</span>
</div>

<div class="header-bar">
    <div>
        <button class="btn-add" onclick="addNewEntry()">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶¶‡¶æ‡¶§‡¶æ</button>
        <button class="dropbtn" id="contactModeBtn" onclick="toggleContactMode()" style="background:#8e44ad; margin-left:5px;">üì± ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶Æ‡ßã‡¶°</button>
        <label style="margin-left: 10px; font-weight: bold; cursor: pointer; font-size: 11px;">
            <input type="checkbox" id="groupByHouse" onchange="renderTable()"> ‡¶¨‡¶æ‡ßú‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ
        </label>
    </div>
    
    <input type="text" id="searchInput" class="search-box" placeholder="üîç ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶¨‡¶æ‡ßú‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." onkeyup="searchFilter()">

    <div class="nav-actions">
        <div class="dropdown">
            <button class="dropbtn" onclick="toggleDropdown('sortMenu')">‡¶∏‡¶æ‡¶ú‡¶æ‡¶® ‚ñº</button>
            <div id="sortMenu" class="dropdown-content">
                <a onclick="sortTable('name')">üî† ‡¶®‡¶æ‡¶Æ (‡¶Ö-‡¶π)</a>
                <a onclick="sortTable('expatriate')">‚úàÔ∏è ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶∏‡ßÄ</a>
                <a onclick="sortTable('due')">‚è≥ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶ï‡¶ø</a>
                <a onclick="renderTable(mosqueData)">üîÑ ‡¶∏‡¶¨‡¶æ‡¶á</a>
            </div>
        </div>
        <div class="dropdown">
            <button class="dropbtn" onclick="toggleDropdown('sysMenu')">‡¶Æ‡ßá‡¶®‡ßÅ ‚ò∞</button>
            <div id="sysMenu" class="dropdown-content">
                <a onclick="window.print()">üíæ PDF / ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</a>
                <a onclick="backupData()">üì§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</a>
                <label for="restoreFile">üì• ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</label>
                <input type="file" id="restoreFile" style="display:none" onchange="restoreData(event)">
            </div>
        </div>
    </div>
</div>

<div id="tableContainer"></div>

<script>
let mosqueData = JSON.parse(localStorage.getItem('mosqueStorageV2')) || [];
let currentYear = new Date().getFullYear();
let isContactMode = false;
const monthNames = ["‡¶ú‡¶æ‡¶®‡ßÅ", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã", "‡¶®‡¶≠‡ßá", "‡¶°‡¶ø‡¶∏‡ßá"];

function toBanglaNum(num) {
    if (num === undefined || num === null) return '‡ß¶';
    const banglaDigits = {'0':'‡ß¶','1':'‡ßß','2':'‡ß®','3':'‡ß©','4':'‡ß™','5':'‡ß´','6':'‡ß¨','7':'‡ß≠','8':'‡ßÆ','9':'‡ßØ'};
    return num.toString().replace(/[0-9]/g, w => banglaDigits[w]);
}

function toggleDropdown(id) {
    document.querySelectorAll('.dropdown-content').forEach(d => { if(d.id !== id) d.classList.remove('show'); });
    document.getElementById(id).classList.toggle('show');
}

function changeYear(step) {
    currentYear += step;
    document.getElementById('yearLabel').innerText = toBanglaNum(currentYear);
    renderTable();
}

function toggleContactMode() {
    isContactMode = !isContactMode;
    document.getElementById('contactModeBtn').innerText = isContactMode ? "üí∞ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨" : "üì± ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶Æ‡ßã‡¶°";
    renderTable();
}

async function addNewEntry() {
    const { value: v } = await Swal.fire({
        title: '‡¶®‡¶§‡ßÅ‡¶® ‡¶¶‡¶æ‡¶§‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø',
        html: `<input id="n" class="swal2-input" placeholder="‡¶®‡¶æ‡¶Æ"><input id="h" class="swal2-input" placeholder="‡¶¨‡¶æ‡ßú‡¶ø"><input id="m" class="swal2-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤"><input id="w" class="swal2-input" placeholder="WhatsApp (‡¶ï‡ßã‡¶°‡¶∏‡¶π)"><input id="b" class="swal2-input" placeholder="‡¶ß‡¶æ‡¶∞‡ßç‡¶Ø ‡¶¨‡ßá‡¶§‡¶® (‡¶ü‡¶æ‡¶ï‡¶æ)" type="number"><div style="margin-top:10px"><input type="checkbox" id="ex"> ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶∏‡ßÄ?</div>`,
        confirmButtonText: '‡¶Ø‡ßã‡¶ó',
        preConfirm: () => [document.getElementById('n').value, document.getElementById('h').value, document.getElementById('m').value, document.getElementById('w').value, document.getElementById('b').value, document.getElementById('ex').checked]
    });
    if (v && v[0]) {
        mosqueData.push({ name: v[0], house: v[1] || "‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø", mobile: v[2] || "", whatsapp: v[3] || "", monthlyBeton: v[4] || 0, isExpatriate: v[5], yearlyData: {} });
        saveAndRender();
    }
}

function renderTable(dataToDisplay = mosqueData) {
    const container = document.getElementById("tableContainer");
    container.innerHTML = "";
    const isGrouped = document.getElementById("groupByHouse").checked;
    if (isGrouped) {
        const groups = {};
        dataToDisplay.forEach(p => { if (!groups[p.house]) groups[p.house] = []; groups[p.house].push(p); });
        for (let house in groups) {
            let section = document.createElement("div");
            section.className = "house-section";
            section.innerHTML = `<div class="house-group-header">üè† ‡¶¨‡¶æ‡ßú‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ: ${house}</div>`;
            section.appendChild(createBaseTable(groups[house]));
            container.appendChild(section);
        }
    } else { container.appendChild(createBaseTable(dataToDisplay)); }
}

function createBaseTable(dataList) {
    const table = document.createElement("table");
    const now = new Date();
    const realYear = now.getFullYear();
    const realMonth = now.getMonth();
    
    let headerHTML = isContactMode ? `<tr><th>‡¶®‡¶Ç</th><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶¨‡¶æ‡ßú‡¶ø</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>WhatsApp</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th></tr>` : 
        `<tr><th>‡¶®‡¶Ç</th><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶¨‡¶æ‡ßú‡¶ø</th><th>‡¶ß‡¶æ‡¶∞‡ßç‡¶Ø</th>${monthNames.map(m => `<th>${m}</th>`).join('')}<th>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡ßü</th><th>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th></tr>`;
    table.innerHTML = `<thead>${headerHTML}</thead><tbody></tbody>`;
    const tbody = table.querySelector("tbody");

    let monthlyTotals = Array(12).fill(0);

    dataList.forEach((p, index) => {
        let pIdx = mosqueData.indexOf(p);
        let yearData = getYearlyData(p, currentYear);
        let row = tbody.insertRow();
        
        row.insertCell(0).innerText = toBanglaNum(index + 1);
        
        let nameHTML = `<span class="clickable-name" onclick="openProfile(${pIdx})">${p.name}</span>`;
        if(p.isExpatriate) nameHTML += `<span class="expatriate-tag">‡¶™‡ßç‡¶∞</span>`;
        row.insertCell(1).innerHTML = nameHTML;
        row.insertCell(2).innerText = p.house;

        let curDueCount = 0;
        let yearlyTotalPaid = 0;
        let yearlyTotalDue = 0;

        if (isContactMode) {
            row.insertCell(3).innerHTML = `<a href="tel:${p.mobile}">${toBanglaNum(p.mobile || '‡¶®‡ßá‡¶á')}</a>`;
            row.insertCell(4).innerHTML = `<a href="https://wa.me/${p.whatsapp}" target="_blank" style="color:#25D366; font-weight:bold;">‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™</a>`;
            // Calculate due for contact mode status
            let pRealData = getYearlyData(p, realYear);
            for (let i=0; i<=realMonth; i++) { if (pRealData.payments[i] <= 0) curDueCount++; }
        } else {
            row.insertCell(3).innerHTML = `<input type="number" class="beton-input" value="${p.monthlyBeton || ''}" onchange="updateBeton(${pIdx}, this.value)">`;
            for (let i = 0; i < 12; i++) {
                let val = parseFloat(yearData.payments[i]) || 0;
                monthlyTotals[i] += val;
                yearlyTotalPaid += val;
                
                let cell = row.insertCell(i + 4);
                if (val > 0) {
                    if (currentYear > realYear || (currentYear === realYear && i > realMonth)) cell.className = "advance";
                    else cell.className = "paid";
                } else if (currentYear < realYear || (currentYear === realYear && i <= realMonth)) { 
                    cell.className = "unpaid-red"; 
                    curDueCount++;
                    yearlyTotalDue += (parseFloat(p.monthlyBeton) || 0);
                }
                cell.innerHTML = `<input type="number" class="tk-input" value="${val || ''}" onchange="updatePay(${pIdx},${i},this.value)">`;
            }
            row.insertCell(16).innerHTML = `<strong>${toBanglaNum(yearlyTotalPaid)}</strong>`;
            row.insertCell(17).innerHTML = `<strong style="color:#d32f2f;">${toBanglaNum(yearlyTotalDue)}</strong>`;
        }

        let statusCell = row.insertCell(isContactMode ? 5 : 18);
        if (curDueCount > 0) statusCell.innerHTML = `<span class="status-badge" style="background:#f8d7da; color:#721c24;">${toBanglaNum(curDueCount)} ‡¶¨‡¶æ‡¶ï‡¶ø</span>`;
        else statusCell.innerHTML = `<span class="status-badge" style="background:#d4edda; color:#155724;">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</span>`;
    });

    if (!isContactMode) {
        let tRow = tbody.insertRow();
        tRow.className = "total-row";
        tRow.innerHTML = `<td colspan="4">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Æ‡ßã‡¶ü:</td>${monthlyTotals.map((t, idx) => `<td onclick="showMonthlyReport(${idx}, ${JSON.stringify(dataList).replace(/"/g, '&quot;')})">${toBanglaNum(t)}</td>`).join('')}<td colspan="3">üìä</td>`;
    }
    return table;
}

function getYearlyData(p, y) { if (!p.yearlyData[y]) p.yearlyData[y] = { payments: Array(12).fill(0), dates: Array(12).fill("") }; return p.yearlyData[y]; }

function updatePay(pIdx, mIdx, val) { 
    val = parseFloat(val) || 0;
    let yd = getYearlyData(mosqueData[pIdx], currentYear);
    yd.payments[mIdx] = val;
    yd.dates[mIdx] = val > 0 ? new Date().toLocaleDateString('bn-BD') : "";
    saveAndRender(); 
}

function updateBeton(pIdx, val) { mosqueData[pIdx].monthlyBeton = parseFloat(val) || 0; saveAndRender(); }

function showMonthlyReport(monthIdx, dataList) {
    let listHTML = '';
    let total = 0;
    dataList.forEach((p, idx) => {
        let val = getYearlyData(p, currentYear).payments[monthIdx];
        if (val > 0) {
            total += val;
            listHTML += `<tr><td>${toBanglaNum(idx+1)}</td><td>${p.name}</td><td>${p.house}</td><td>${toBanglaNum(val)} ‡ß≥</td></tr>`;
        }
    });
    Swal.fire({
        title: `${monthNames[monthIdx]} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶Ü‡¶¶‡¶æ‡ßü‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü`,
        html: `<table border="1" style="width:100%; border-collapse:collapse;">
                <tr style="background:#eee;"><th>‡¶®‡¶Ç</th><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶¨‡¶æ‡ßú‡¶ø</th><th>‡¶ü‡¶æ‡¶ï‡¶æ</th></tr>
                ${listHTML || '<tr><td colspan="4">‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶¶‡¶æ‡ßü ‡¶π‡ßü‡¶®‡¶ø</td></tr>'}
                <tr style="font-weight:bold; background:#f0f0f0;"><td colspan="3">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü:</td><td>${toBanglaNum(total)} ‡ß≥</td></tr>
               </table>`,
        confirmButtonText: '‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®'
    });
}

async function openProfile(idx) {
    const p = mosqueData[idx];
    const yd = getYearlyData(p, currentYear);
    const now = new Date();
    const realYear = now.getFullYear();
    const realMonth = now.getMonth();
    
    let dueCount = 0, advCount = 0;
    if (currentYear === realYear) {
        yd.payments.forEach((v, i) => {
            if (i <= realMonth && v <= 0) dueCount++;
            if (i > realMonth && v > 0) advCount++;
        });
    } else if (currentYear < realYear) {
        yd.payments.forEach(v => { if (v <= 0) dueCount++; });
    } else {
        yd.payments.forEach(v => { if (v > 0) advCount++; });
    }

    let statusMsg = "";
    if (dueCount > 0) {
        statusMsg = `<p style="color:#d32f2f; font-weight:bold; font-size:14px;">‚ö†Ô∏è ${toBanglaNum(currentYear)} ‡¶∏‡¶æ‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${toBanglaNum(dueCount)} ‡¶Æ‡¶æ‡¶∏ ‡¶¨‡¶æ‡¶ï‡¶ø‡•§</p>`;
    } else if (advCount > 0) {
        statusMsg = `<p style="color:#2e7d32; font-weight:bold; font-size:14px;">‚úÖ ‡¶Ü‡¶≤‡¶π‡¶æ‡¶Æ‡¶¶‡ßÅ‡¶≤‡¶ø‡¶≤‡ßç‡¶≤‡¶æ‡¶π! ‡¶Ü‡¶™‡¶®‡¶ø ${toBanglaNum(advCount)} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶ú‡¶æ‡¶ú‡¶æ‡¶ï‡¶æ‡¶≤‡ßç‡¶≤‡¶æ‡¶π‡ßÅ ‡¶ñ‡¶æ‡¶á‡¶∞‡¶æ‡¶®‡•§</p>`;
    } else {
        statusMsg = `<p style="color:#2e7d32; font-weight:bold; font-size:14px;">‚ú® ‡¶Ü‡¶≤‡¶π‡¶æ‡¶Æ‡¶¶‡ßÅ‡¶≤‡¶ø‡¶≤‡ßç‡¶≤‡¶æ‡¶π! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Æ‡¶æ‡¶∏ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶∏‡¶¨ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶ú‡¶æ‡¶ú‡¶æ‡¶ï‡¶æ‡¶≤‡ßç‡¶≤‡¶æ‡¶π‡ßÅ ‡¶ñ‡¶æ‡¶á‡¶∞‡¶æ‡¶®‡•§</p>`;
    }

    let historyHTML = '';
    yd.payments.forEach((val, i) => {
        historyHTML += `<tr><td>${monthNames[i]}</td><td>${val > 0 ? toBanglaNum(val) + ' ‡ß≥' : '-'}</td><td>${yd.dates[i] || '-'}</td></tr>`;
    });

    Swal.fire({
        width: '500px',
        html: `
            <div id="printableProfile" style="text-align:left; padding:10px; border:1px solid #ddd; border-radius:10px;">
                <h3 style="color:#27ae60; border-bottom:2px solid #27ae60; padding-bottom:5px;">üïå ‡¶π‡¶æ‡¶¨‡¶ø‡¶¨ ‡¶â‡¶≤‡ßç‡¶Ø‡¶æ ‡¶≠‡ßÇ‡¶Å‡¶á‡ßü‡¶æ ‡¶ú‡¶æ‡¶Æ‡ßá ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶¶‡¶æ‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ (${toBanglaNum(currentYear)})</h3>
                <div style="margin-bottom:15px;">
                    <p><strong>‡¶®‡¶æ‡¶Æ:</strong> ${p.name} ${p.isExpatriate ? '<span style="color:#e67e22; font-size:12px;">(‡¶™‡ßç‡¶∞)</span>' : ''}</p>
                    <p><strong>‡¶¨‡¶æ‡ßú‡¶ø:</strong> ${p.house} | <strong>‡¶ß‡¶æ‡¶∞‡ßç‡¶Ø:</strong> ${toBanglaNum(p.monthlyBeton)} ‡ß≥</p>
                    <p><strong>WhatsApp:</strong> <a href="https://wa.me/${p.whatsapp}" target="_blank" style="color:#25D366; text-decoration:none;">${toBanglaNum(p.whatsapp) || '‡¶®‡ßá‡¶á'}</a></p>
                </div>
                
                <div style="background:#f9f9f9; padding:10px; border-radius:8px; text-align:center; margin-bottom:15px; border:1px solid #eee;">
                    ${statusMsg}
                </div>

                <div style="margin-bottom:15px;" class="no-print">
                    <button class="dropbtn" onclick="editEntry(${idx})">üìù ‡¶è‡¶°‡¶ø‡¶ü</button>
                    <button class="dropbtn" style="background:#e67e22;" onclick="downloadProfile()">üì• ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° / ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
                    <button class="dropbtn" style="background:#e74c3c;" onclick="deleteEntry(${idx})">üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                </div>

                <table border="1" style="width:100%; border-collapse:collapse; font-size:12px;">
                    <tr style="background:#eee;"><th>‡¶Æ‡¶æ‡¶∏</th><th>‡¶ü‡¶æ‡¶ï‡¶æ</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th></tr>
                    ${historyHTML}
                </table>
            </div>`,
        showConfirmButton: false
    });
}

function downloadProfile() {
    const printContents = document.getElementById("printableProfile").innerHTML;
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>‡¶¶‡¶æ‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</title><style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ddd; padding:8px; text-align:center;} .no-print{display:none;} h3{color:#27ae60;}</style></head><body>');
    printWindow.document.write(printContents);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}

async function editEntry(idx) {
    const p = mosqueData[idx]; Swal.close();
    const { value: v } = await Swal.fire({
        title: '‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü',
        html: `
            <input id="en" class="swal2-input" placeholder="‡¶®‡¶æ‡¶Æ" value="${p.name}">
            <input id="eh" class="swal2-input" placeholder="‡¶¨‡¶æ‡ßú‡¶ø" value="${p.house}">
            <input id="em" class="swal2-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤" value="${p.mobile}">
            <input id="ew" class="swal2-input" placeholder="WhatsApp" value="${p.whatsapp}">
            <input id="eb" class="swal2-input" placeholder="‡¶ß‡¶æ‡¶∞‡ßç‡¶Ø ‡¶¨‡ßá‡¶§‡¶®" type="number" value="${p.monthlyBeton}">
            <div style="margin-top:10px">
                <input type="checkbox" id="eex" ${p.isExpatriate ? 'checked' : ''}> <label for="eex">‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶∏‡ßÄ?</label>
            </div>`,
        preConfirm: () => [
            document.getElementById('en').value, 
            document.getElementById('eh').value, 
            document.getElementById('em').value, 
            document.getElementById('ew').value, 
            document.getElementById('eb').value,
            document.getElementById('eex').checked
        ]
    });
    if (v) { 
        Object.assign(p, {name:v[0], house:v[1], mobile:v[2], whatsapp:v[3], monthlyBeton:v[4], isExpatriate:v[5]}); 
        saveAndRender(); 
        openProfile(idx); 
    }
}

async function deleteEntry(idx) {
    const r = await Swal.fire({ title: '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?', text: "‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶¨ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá!", icon: 'warning', showCancelButton: true, confirmButtonText: '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å', cancelButtonText: '‡¶®‡¶æ' });
    if (r.isConfirmed) { mosqueData.splice(idx, 1); saveAndRender(); }
}

function searchFilter() {
    let t = document.getElementById("searchInput").value.toLowerCase();
    renderTable(mosqueData.filter(p => p.name.toLowerCase().includes(t) || p.house.toLowerCase().includes(t)));
}

function sortTable(type) {
    let f = [...mosqueData];
    if (type === 'name') f.sort((a,b) => a.name.localeCompare(b.name, 'bn'));
    else if (type === 'expatriate') f = f.filter(p => p.isExpatriate);
    renderTable(f);
}

function saveAndRender() { localStorage.setItem('mosqueStorageV2', JSON.stringify(mosqueData)); renderTable(); }
function backupData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(mosqueData)], {type: 'application/json'})); a.download = `HUB_Backup.json`; a.click(); }
function restoreData(e) { const r = new FileReader(); r.onload = (ev) => { mosqueData = JSON.parse(ev.target.result); saveAndRender(); }; r.readAsText(e.target.files[0]); }
window.onload = () => { document.getElementById('yearLabel').innerText = toBanglaNum(currentYear); renderTable(); };
</script>
</body>
    </html>
